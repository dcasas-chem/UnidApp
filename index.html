<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UnidApp</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Lexend -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #fca5a5 0%, #fdba74 100%);
            --color-primary-600: #dc2626; /* red-600 */
            --color-primary-700: #b91c1c; /* red-700 */
            --btn-gradient: linear-gradient(45deg, #ef4444, #f97316);
            --btn-shadow: rgba(239, 68, 68, 0.5);
        }
        /* THEME: Magnitudes Simples */
        body.theme-simple {
            --bg-gradient: linear-gradient(135deg, #7dd3fc 0%, #38bdf8 100%);
            --color-primary-600: #0369a1; --color-primary-700: #075985;
            --btn-gradient: linear-gradient(45deg, #38bdf8, #0ea5e9);
            --btn-shadow: rgba(56, 189, 248, 0.5);
        }
        /* THEME: Magnitudes Derivadas */
        body.theme-derived {
            --bg-gradient: linear-gradient(135deg, #c4b5fd 0%, #a78bfa 100%);
            --color-primary-600: #7c3aed; --color-primary-700: #6d28d9;
            --btn-gradient: linear-gradient(45deg, #a855f7, #8b5cf6);
            --btn-shadow: rgba(168, 85, 247, 0.5);
        }
        /* THEME: Múltiplos y Submúltiplos */
        body.theme-prefix {
            --bg-gradient: linear-gradient(135deg, #86efac 0%, #4ade80 100%);
            --color-primary-600: #16a34a; --color-primary-700: #15803d;
            --btn-gradient: linear-gradient(45deg, #4ade80, #22c55e);
            --btn-shadow: rgba(74, 222, 128, 0.5);
        }
        /* THEME: Notación Científica */
        body.theme-scientific {
            --bg-gradient: linear-gradient(135deg, #fcd34d 0%, #fbbf24 100%);
            --color-primary-600: #d97706; --color-primary-700: #b45309;
            --btn-gradient: linear-gradient(45deg, #fbbf24, #f59e0b);
            --btn-shadow: rgba(251, 191, 36, 0.5);
        }

        body {
            font-family: 'Lexend', sans-serif;
            background: var(--bg-gradient);
            color: #2d3748;
            transition: background 0.5s ease-in-out;
        }
        .glass-container {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }
        .theme-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            color: white; border-radius: 1rem;
        }
        .theme-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .fc-input {
            -moz-appearance: textfield; background-color: #f8fafc;
            border: 1px solid #cbd5e1; color: #1e293b;
            text-align: center; border-radius: 0.375rem;
            padding: 0.5rem; width: 6rem;
        }
        .fc-input::-webkit-inner-spin-button, .fc-input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .btn-primary {
            background: var(--btn-gradient);
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--btn-shadow);
        }
        .level-radio-label {
            border: 2px solid #cbd5e1; transition: all 0.2s ease-in-out;
        }
        .level-radio:checked + .level-radio-label {
            border-color: var(--color-primary-600); background-color: rgba(255,255,255,0.5);
            color: var(--color-primary-700); transform: scale(1.05);
        }
        .sci-notation-container {
            display: flex; align-items: flex-start; gap: 0.25rem;
        }
        .sci-exponent-input {
            width: 4rem; padding: 0.1rem 0.25rem; font-size: 0.75rem;
            margin-top: -0.2rem; margin-left: -0.25rem;
        }
        .text-theme-600 { color: var(--color-primary-600); }
        .text-theme-700 { color: var(--color-primary-700); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto glass-container rounded-2xl p-6 md:p-8">
        
        <div id="main-menu">
            <div class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-orange-500 tracking-tight">UnidApp</h1>
                <p class="text-gray-600 mt-2">Domina los factores de conversión del Sistema Internacional.</p>
            </div>
            <div id="stats-container" class="text-center mb-6 p-4 bg-white/50 rounded-lg border border-gray-200"></div>
            <div id="theme-selection" class="fade-in">
                <h2 class="text-lg font-semibold text-center text-theme-600 mb-6">Elige una categoría para comenzar</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <button data-theme="simple" class="theme-card text-left p-5 bg-gradient-to-br from-sky-500 to-cyan-400">
                        <h3 class="text-lg font-bold mb-1">Magnitudes Simples</h3>
                        <p class="text-sky-100 text-sm">Longitud, masa, tiempo, temperatura...</p>
                    </button>
                    <button data-theme="derived" class="theme-card text-left p-5 bg-gradient-to-br from-purple-500 to-indigo-500">
                        <h3 class="text-lg font-bold mb-1">Magnitudes Derivadas</h3>
                        <p class="text-purple-100 text-sm">Área, volumen, velocidad, densidad...</p>
                    </button>
                    <button data-theme="prefix" class="theme-card text-left p-5 bg-gradient-to-br from-emerald-500 to-lime-500">
                        <h3 class="text-lg font-bold mb-1">Múltiplos y Submúltiplos</h3>
                        <p class="text-emerald-100 text-sm">Practica con prefijos: de Giga a nano.</p>
                    </button>
                    <button data-theme="scientific" class="theme-card text-left p-5 bg-gradient-to-br from-amber-500 to-orange-500">
                        <h3 class="text-lg font-bold mb-1">Notación Científica</h3>
                        <p class="text-amber-100 text-sm">Conversiones y formato SI.</p>
                    </button>
                </div>
            </div>
        </div>

        <div id="settings-view" class="hidden fade-in text-center">
            <h2 id="settings-title" class="text-2xl font-bold text-theme-600 mb-6"></h2>
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">1. Elige el Nivel</h3>
                <div id="level-selection" class="grid grid-cols-2 gap-4 max-w-sm mx-auto"></div>
            </div>
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">2. Elige el número de preguntas</h3>
                <div id="question-count-selection" class="flex justify-center flex-wrap gap-4">
                    <button data-count="10" class="btn-primary text-white font-bold py-3 px-8 rounded-lg text-lg">10</button>
                    <button data-count="15" class="btn-primary text-white font-bold py-3 px-8 rounded-lg text-lg">15</button>
                    <button data-count="20" class="btn-primary text-white font-bold py-3 px-8 rounded-lg text-lg">20</button>
                </div>
            </div>
            <button id="back-to-themes-btn" class="text-theme-600 hover:opacity-75 mt-4 flex items-center gap-1.5 mx-auto"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>Volver</button>
        </div>

        <div id="game-view" class="hidden"></div>
        
        <div id="game-over-view" class="hidden fade-in text-center p-8">
            <h2 id="game-over-title" class="text-3xl font-bold text-theme-600 mb-4">¡Partida Terminada!</h2>
            <p id="final-score-text" class="text-xl text-gray-700 mb-8"></p>
            <button id="play-again-btn" class="btn-primary text-white font-bold py-3 px-10 rounded-lg text-lg">Jugar de Nuevo</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const DATA = {
            simple: {
                name: 'Magnitudes Simples', 
                levels: { 1: 'Varios pasos (varios factores)', 2: 'Paso directo (1 factor)' },
                magnitudes: {
                    longitud: { name: 'Longitud', path: ['km', 'm', 'cm', 'mm'], units: { 'km': 1000, 'm': 100, 'cm': 10 } },
                    masa: { name: 'Masa', path: ['t', 'kg', 'g', 'mg'], units: { 't': 1000, 'kg': 1000, 'g': 1000 } },
                    tiempo: { name: 'Tiempo', path: ['h', 'min', 's'], units: { 'h': 60, 'min': 60 } },
                    temperatura: { name: 'Temperatura', path: ['°C', 'K'], units: {} },
                    moles: { name: 'Cantidad de Sustancia', path: ['kmol', 'mol', 'mmol'], units: { 'kmol': 1000, 'mol': 1000 } },
                    amperios: { name: 'Intensidad de Corriente', path: ['kA', 'A', 'mA'], units: { 'kA': 1000, 'A': 1000 } }
                }
            },
            derived: {
                name: 'Magnitudes Derivadas', levels: { 1: 'Área y Volumen', 2: 'Densidad, velocidad, etc.' },
                magnitudes: {
                    area: { name: 'Área', path: ['km²', 'm²', 'cm²'], units: { 'km²': 1e6, 'm²': 1e4 } },
                    volumen: { name: 'Volumen', path: ['m³', 'dm³', 'cm³'], units: { 'm³': 1000, 'dm³': 1000 } },
                    velocidad: { name: 'Velocidad', from: 'km/h', to: 'm/s', factors: [{num: 1000, num_unit: 'm', den: 1, den_unit: 'km'}, {num: 1, num_unit: 'h', den: 3600, den_unit: 's'}] },
                    densidad: { name: 'Densidad', from: 'g/cm³', to: 'kg/m³', factors: [{num: 1, num_unit: 'kg', den: 1000, den_unit: 'g'}, {num: 1000000, num_unit: 'cm³', den: 1, den_unit: 'm³'}] },
                    aceleracion: { name: 'Aceleración', from: 'km/h²', to: 'm/s²', factors: [{num: 1000, num_unit: 'm', den: 1, den_unit: 'km'}, {num: 1, num_unit: 'h²', den: 12960000, den_unit: 's²'}] },
                    fuerza: { name: 'Fuerza', from: 'g·cm/s²', to: 'kg·m/s²', factors: [{num: 1, num_unit: 'kg', den: 1000, den_unit: 'g'}, {num: 1, num_unit: 'm', den: 100, den_unit: 'cm'}] }
                }
            },
            prefix: {
                name: 'Múltiplos y Submúltiplos', 
                levels: { 1: 'Paso intermedio (2 factores)', 2: 'Cambio directo (1 factor)' },
                base_units: ['m', 'g', 's', 'L', 'A'], path: ['G', 'M', 'k', '', 'c', 'm', 'µ', 'n'],
                units: { 'G': 1e9, 'M': 1e6, 'k': 1e3, '': 1, 'c': 1e-2, 'm': 1e-3, 'µ': 1e-6, 'n': 1e-9 }
            },
            scientific: {
                name: 'Notación Científica', 
                levels: { 1: 'Escribir un número en N.C. y viceversa', 2: 'Hacer una conversión y dar el resultado en N.C.' }
            }
        };

        const mainMenu = document.getElementById('main-menu'), settingsView = document.getElementById('settings-view'), gameView = document.getElementById('game-view'), gameOverView = document.getElementById('game-over-view');
        const allViews = [mainMenu, settingsView, gameView, gameOverView];
        const bodyEl = document.body;
        
        let gameState = {}, currentTheme = '';

        const parseFloatWithComma = str => typeof str === 'string' ? parseFloat(str.replace(',', '.')) : parseFloat(str);
        const showView = view => { allViews.forEach(v => v.classList.add('hidden')); view.classList.remove('hidden'); };
        const getStats = () => JSON.parse(localStorage.getItem('conversionStats')) || { correct: 0, total: 0 };
        const saveStats = stats => localStorage.setItem('conversionStats', JSON.stringify(stats));
        const setTheme = theme => {
            bodyEl.className = bodyEl.className.replace(/theme-\w+/g, '');
            if(theme) bodyEl.classList.add(`theme-${theme}`);
        };
        
        const updateStatsDisplay = () => {
            const stats = getStats();
            const accuracy = stats.total > 0 ? ((stats.correct / stats.total) * 100).toFixed(1) : 0;
            document.getElementById('stats-container').innerHTML = `<div class="flex items-center justify-center gap-4"><div><h3 class="font-bold text-gray-800">Estadísticas Globales</h3><p class="text-sm text-gray-700">Aciertos: <span class="font-semibold text-green-600">${stats.correct}</span> de <span class="font-semibold text-blue-600">${stats.total}</span> | Precisión: <span class="font-semibold text-yellow-600">${accuracy}%</span></p></div><button id="reset-stats-btn" class="p-2 rounded-full hover:bg-red-500/10" title="Borrar datos"><svg class="w-5 h-5 text-gray-500 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`;
            document.getElementById('reset-stats-btn').addEventListener('click', () => { if (confirm('¿Estás seguro?')) { localStorage.removeItem('conversionStats'); updateStatsDisplay(); } });
        };
        
        document.getElementById('theme-selection').addEventListener('click', e => {
            const themeBtn = e.target.closest('button[data-theme]'); if (!themeBtn) return;
            currentTheme = themeBtn.dataset.theme; 
            setTheme(currentTheme);
            const themeData = DATA[currentTheme];
            document.getElementById('settings-title').textContent = `Configurar: ${themeData.name}`;
            const levelContainer = document.getElementById('level-selection'); levelContainer.innerHTML = '';
            Object.entries(themeData.levels).forEach(([level, desc], i) => {
                levelContainer.innerHTML += `<div><input type="radio" name="level" value="${level}" id="level-${level}" class="sr-only level-radio" ${i === 0 ? 'checked' : ''}><label for="level-${level}" class="level-radio-label block p-4 rounded-lg cursor-pointer"><span class="font-bold block">Nivel ${level}</span><span class="text-sm text-gray-600">${desc}</span></label></div>`;
            });
            showView(settingsView);
        });
        
        const goBackToMenu = () => { setTheme(null); showView(mainMenu); };
        document.getElementById('back-to-themes-btn').addEventListener('click', goBackToMenu);
        document.getElementById('play-again-btn').addEventListener('click', () => { updateStatsDisplay(); goBackToMenu(); });

        settingsView.addEventListener('click', e => {
            const countBtn = e.target.closest('button[data-count]'); if (!countBtn) return;
            const currentLevel = parseInt(settingsView.querySelector('input[name="level"]:checked').value);
            gameState = { current: 0, score: 0, total: parseInt(countBtn.dataset.count), problem: {}, level: currentLevel };
            gameView.innerHTML = `<div class="flex items-center justify-between mb-2 text-sm"><button id="back-btn" class="text-theme-600 hover:opacity-75 flex items-center gap-1.5"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>Salir</button><div id="score-display" class="font-semibold text-gray-700"></div></div><div class="w-full bg-gray-200 rounded-full h-2 mb-4"><div id="progress-bar" class="bg-yellow-400 h-2 rounded-full transition-all"></div></div><div id="problem-container"></div><div class="mt-6 flex justify-center"><button id="check-btn" class="btn-primary px-8 py-3 text-white font-semibold rounded-lg">Comprobar</button></div><div id="feedback-container" class="hidden mt-5"></div><div class="text-center"><button id="next-btn" class="hidden mt-5 btn-primary px-8 py-3 text-white font-semibold rounded-lg">Siguiente →</button></div>`;
            document.getElementById('back-btn').addEventListener('click', goBackToMenu);
            document.getElementById('check-btn').addEventListener('click', checkAnswer);
            document.getElementById('next-btn').addEventListener('click', generateProblem);
            showView(gameView);
            generateProblem();
        });

        const getRandomElement = arr => arr[Math.floor(Math.random() * arr.length)];
        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        function generateProblem() {
            if (gameState.current >= gameState.total) { endGame(); return; }
            gameState.current++;
            const generators = { simple: generateSimpleProblem, derived: generateDerivedProblem, prefix: generatePrefixProblem, scientific: generateScientificProblem };
            gameState.problem = generators[currentTheme](gameState.level);
            updateUIForNewProblem();
        }

        function generateSimpleProblem(level) {
            const mag = getRandomElement(Object.values(DATA.simple.magnitudes));
            let fromIndex, toIndex;
            if (level === 2) { // 1 paso (adyacente)
                fromIndex = getRandomInt(0, mag.path.length - 2); toIndex = fromIndex + 1;
            } else { // Varios pasos (no adyacente)
                fromIndex = 0; toIndex = mag.path.length - 1;
            }
            if (Math.random() > 0.5) [fromIndex, toIndex] = [toIndex, fromIndex];
            
            const initialValue = getRandomInt(1, 200), fromUnit = mag.path[fromIndex], toUnit = mag.path[toIndex];
            
            if (mag.name === 'Temperatura') {
                const fromC = fromUnit === '°C';
                return {
                    title: mag.name, type: 'temperature', initialValue, fromUnit, toUnit,
                    operation: fromC ? '+' : '-',
                    operand: 273.15,
                    answer: fromC ? initialValue + 273.15 : initialValue - 273.15
                };
            }

            const steps = Math.abs(fromIndex - toIndex);
            let factors = [];
            let tempValue = initialValue;
            const forward = fromIndex < toIndex;
            for(let i = 0; i < steps; i++) {
                const currentIdx = forward ? fromIndex + i : fromIndex - i;
                const unit1 = mag.path[currentIdx], unit2 = mag.path[forward ? currentIdx + 1 : currentIdx - 1];
                const factorVal = mag.units[forward ? unit1 : unit2];
                factors.push({ num: forward ? factorVal : 1, num_unit: unit2, den: forward ? 1 : factorVal, den_unit: unit1 });
                tempValue = forward ? tempValue * factorVal : tempValue / factorVal;
            }
            return { title: mag.name, initialValue, fromUnit, toUnit, factors, answer: tempValue };
        }

        function generateDerivedProblem(level) {
            const mags = DATA.derived.magnitudes;
            const magKey = getRandomElement(level === 1 ? ['area', 'volumen'] : Object.keys(mags).filter(k=>!['area','volumen'].includes(k)));
            const mag = mags[magKey];
            const initialValue = getRandomInt(1, 200);
            let problem = { title: mag.name, initialValue };

            if(mag.path) {
                let from, to;
                do { from = getRandomElement(mag.path); to = getRandomElement(mag.path); } while (from === to);
                problem.fromUnit = from; problem.toUnit = to;
                const fromIdx = mag.path.indexOf(from), toIdx = mag.path.indexOf(to);
                let tempValue = initialValue; problem.factors = [];
                const forward = fromIdx < toIdx;
                for(let i = 0; i < Math.abs(fromIdx - toIdx); i++) {
                    const currentIdx = forward ? fromIdx + i : fromIdx - i;
                    const unit1 = mag.path[currentIdx], unit2 = mag.path[forward ? currentIdx + 1 : currentIdx - 1];
                    const factorVal = mag.units[forward ? unit1 : unit2];
                    problem.factors.push({num: forward ? factorVal : 1, num_unit: unit2, den: forward ? 1 : factorVal, den_unit: unit1});
                    tempValue = forward ? tempValue * factorVal : tempValue / factorVal;
                }
                problem.answer = tempValue;
            } else {
                problem.fromUnit = mag.from; problem.toUnit = mag.to; problem.factors = mag.factors;
                problem.answer = mag.factors.reduce((acc, f) => acc * (f.num / f.den), initialValue);
            }
            return problem;
        }
        
        function generatePrefixProblem(level) {
            const { base_units, path, units } = DATA.prefix;
            const baseUnit = getRandomElement(base_units);
            let fromPrefix, toPrefix;
            if (level === 2) { // Directo (1 factor)
                 do { fromPrefix = getRandomElement(path); toPrefix = getRandomElement(path); } while (fromPrefix === toPrefix);
            } else { // Intermedio (2 factores)
                do { fromPrefix = getRandomElement(path.filter(p=>p!=='')); toPrefix = getRandomElement(path.filter(p=>p!=='')); } while (fromPrefix === toPrefix);
            }
            
            const initialValue = getRandomInt(1, 500);
            const factorFromBase = units[fromPrefix];
            const factorToBase = units[toPrefix];
            const correctValue = initialValue * (factorFromBase / factorToBase);
            let factors = [];

            if (level === 2) {
                const factor = factorFromBase / factorToBase;
                factors.push({ num: factor > 1 ? factor : 1, num_unit: toPrefix + baseUnit, den: factor < 1 ? 1/factor : 1, den_unit: fromPrefix + baseUnit });
            } else {
                factors.push({ num: factorFromBase, num_unit: baseUnit, den: 1, den_unit: fromPrefix + baseUnit });
                factors.push({ num: 1, num_unit: toPrefix + baseUnit, den: factorToBase, den_unit: baseUnit });
            }
            
            return { title: 'Múltiplos y Submúltiplos', initialValue, fromUnit: fromPrefix + baseUnit, toUnit: toPrefix + baseUnit, factors, answer: correctValue };
        }

        function generateScientificProblem(level) {
            let problem = { title: 'Notación Científica', type: 'scientific' };
            const num = (Math.random() * 1e5 * (Math.random() > 0.5 ? 1 : -1)) + (Math.random() * 1e-3);
            const sci = num.toExponential(3).split('e');
            
            if (level === 1) {
                if (Math.random() > 0.5) {
                    problem.instruction = 'Escribe el siguiente número en notación científica:';
                    problem.initialValue = parseFloat(num.toPrecision(4));
                    problem.fromUnit = ''; problem.toUnit = 'N.C.';
                    problem.answer = { mantissa: parseFloat(sci[0]), exponent: parseInt(sci[1]) };
                } else {
                    problem.instruction = 'Escribe el siguiente número en formato decimal:';
                    problem.initialValue = `${sci[0]} x 10^${parseInt(sci[1])}`;
                    problem.fromUnit = ''; problem.toUnit = 'decimal';
                    problem.answer = { mantissa: parseFloat(num.toPrecision(4)) };
                }
            } else {
                const prefixProblem = generatePrefixProblem(1);
                problem.instruction = `Convierte y expresa el resultado en N.C.:`;
                problem.initialValue = prefixProblem.initialValue;
                problem.fromUnit = prefixProblem.fromUnit;
                problem.toUnit = prefixProblem.toUnit;
                const finalValueSci = prefixProblem.answer.toExponential(3).split('e');
                problem.answer = { mantissa: parseFloat(finalValueSci[0]), exponent: parseInt(finalValueSci[1]), unit: prefixProblem.toUnit };
            }
            return problem;
        }
        
        function updateUIForNewProblem() {
            const { title, initialValue, fromUnit, toUnit, factors, type, instruction, operation } = gameState.problem;
            updateProgress();
            
            const problemHTML = `<div class="bg-white/50 p-5 rounded-lg border text-center">
                <p class="text-gray-600 mb-2 font-semibold">${title}</p>
                <p id="question-instruction" class="text-xl font-bold text-theme-700 mb-6"></p>
                <div id="problem-statement-container" class="flex items-center justify-center flex-wrap gap-2 text-xl"></div>
            </div>`;
            gameView.querySelector('#problem-container').innerHTML = problemHTML;

            gameView.querySelector('#question-instruction').textContent = instruction || `Convierte ${initialValue} ${fromUnit} en ${toUnit}`;
            const container = gameView.querySelector('#problem-statement-container');
            let statementHTML = '';

            if (type === 'temperature') {
                statementHTML = `<div class="font-bold text-theme-600">${initialValue} ${fromUnit}</div>
                <div class="text-2xl font-bold text-gray-600 mx-2">${operation}</div>
                <input type="number" class="fc-input" data-role="temp-operand">
                <div class="text-2xl font-bold text-gray-600 mx-2">=</div>
                <div class="flex items-center gap-2">
                    <input type="number" class="fc-input font-bold" data-role="result"> <span class="font-bold text-theme-600">${toUnit}</span>
                </div>`;
            } else if (type === 'scientific' && gameState.level === 1) {
                statementHTML = `<div class="font-bold text-theme-600">${initialValue} ${fromUnit}</div>
                <div class="text-2xl font-bold text-gray-600 mx-2">→</div>`;
                if (gameState.problem.answer.exponent !== undefined) {
                     statementHTML += `<div class="sci-notation-container">
                        <input type="number" class="fc-input w-28" data-role="sci-mantissa">
                        <span class="font-bold text-2xl">× 10</span>
                        <input type="number" class="fc-input sci-exponent-input" data-role="sci-exponent">
                     </div>`;
                } else {
                     statementHTML += `<input type="number" class="fc-input font-bold" data-role="sci-decimal">`;
                }
            } else if (type === 'scientific' && gameState.level === 2) {
                 statementHTML = `<div class="font-bold text-theme-600">${initialValue} ${fromUnit}</div>
                    <div class="text-2xl font-bold text-gray-600 mx-2">=</div>
                    <div class="sci-notation-container">
                        <input type="number" class="fc-input w-28" data-role="sci-mantissa">
                        <span class="font-bold text-2xl">× 10</span>
                        <input type="number" class="fc-input sci-exponent-input" data-role="sci-exponent">
                        <input type="text" class="fc-input w-24" data-role="sci-unit">
                    </div>`;
            } else {
                let factorsHTML = (factors || []).map((f, i) => `
                    <div class="text-2xl font-bold text-gray-600 mx-2">×</div>
                    <div class="flex flex-col items-center">
                        <div class="flex items-center gap-2"><input type="number" class="fc-input" data-role="factor-num" data-index="${i}"> <span class="font-semibold">${f.num_unit}</span></div>
                        <div class="w-full border-t-2 border-gray-700 my-1"></div>
                        <div class="flex items-center gap-2"><input type="number" class="fc-input" data-role="factor-den" data-index="${i}"> <span class="font-semibold">${f.den_unit}</span></div>
                    </div>`).join('');
                
                const resultHTML = `<div class="flex items-center gap-2">
                    <input type="number" class="fc-input font-bold" data-role="result"> <span class="font-bold text-theme-600">${toUnit}</span>
                </div>`;

                statementHTML = `<div class="font-bold text-theme-600">${initialValue} ${fromUnit}</div>
                    ${factorsHTML}
                    <div class="text-2xl font-bold text-gray-600 mx-2">=</div>
                    ${resultHTML}`;
            }
            container.innerHTML = statementHTML;

            document.getElementById('check-btn').classList.remove('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            const feedbackContainer = document.getElementById('feedback-container');
            feedbackContainer.classList.add('hidden');
            feedbackContainer.innerHTML = '';
        }
        
        const updateProgress = () => {
             gameView.querySelector('#progress-bar').style.width = `${(gameState.current - 1) / gameState.total * 100}%`;
             gameView.querySelector('#score-display').textContent = `Pregunta: ${gameState.current}/${gameState.total} | Aciertos: ${gameState.score}`;
        };

        function checkAnswer() {
            const inputs = Array.from(gameView.querySelectorAll('input'));
            if (inputs.some(input => input.value.trim() === '')) {
                showFeedback(false, ['Debes rellenar todas las casillas.']);
                return;
            }

            const p = gameState.problem; let errors = [];
            let isCorrect = true;

            if (p.type === 'temperature') {
                const operandInput = parseFloatWithComma(gameView.querySelector('[data-role="temp-operand"]').value);
                if (operandInput !== p.operand) { isCorrect = false; errors.push('El valor de la conversión es incorrecto.');}
            } else if (p.type === 'scientific') {
                const ans = p.answer;
                if(ans.exponent !== undefined) {
                    const mantissaInput = parseFloatWithComma(gameView.querySelector('[data-role="sci-mantissa"]').value);
                    const exponentInput = parseInt(gameView.querySelector('[data-role="sci-exponent"]').value);
                    if(Math.abs(mantissaInput - ans.mantissa) > 0.01) {isCorrect = false; errors.push('La mantisa es incorrecta.');}
                    if(exponentInput !== ans.exponent) {isCorrect = false; errors.push('El exponente es incorrecto.');}
                    if(ans.unit) {
                        const unitInput = gameView.querySelector('[data-role="sci-unit"]').value;
                        if(unitInput.toLowerCase().replace(/ /g, '') !== ans.unit.toLowerCase().replace(/ /g, '')) {isCorrect = false; errors.push('La unidad final es incorrecta.');}
                    }
                } else {
                    const decimalInput = parseFloatWithComma(gameView.querySelector('[data-role="sci-decimal"]').value);
                    if(Math.abs(decimalInput - ans.mantissa) > 0.01) {isCorrect = false; errors.push('El número decimal es incorrecto.');}
                }
            }
            
            if (p.factors) {
                 p.factors.forEach((factor, i) => {
                    const numInput = parseFloatWithComma(gameView.querySelector(`[data-role="factor-num"][data-index="${i}"]`).value);
                    const denInput = parseFloatWithComma(gameView.querySelector(`[data-role="factor-den"][data-index="${i}"]`).value);
                    if(numInput !== factor.num) { isCorrect = false; errors.push(`El numerador del factor ${i+1} es incorrecto.`); }
                    if(denInput !== factor.den) { isCorrect = false; errors.push(`El denominador del factor ${i+1} es incorrecto.`); }
                });
            }

            const resultInput = gameView.querySelector(`[data-role="result"]`);
            if(resultInput) {
                const resultVal = parseFloatWithComma(resultInput.value);
                const tolerance = Math.abs(p.answer * 0.01);
                if (Math.abs(resultVal - p.answer) > Math.max(0.01, tolerance)) { isCorrect = false; errors.push('El resultado final es incorrecto.'); }
            }
            
            const stats = getStats(); stats.total++;
            if (isCorrect) { gameState.score++; stats.correct++; }
            saveStats(stats);
            showFeedback(isCorrect, errors);
        }
        
        function showFeedback(isCorrect, errors) {
            const feedbackContainer = document.getElementById('feedback-container');
            const p = gameState.problem;
            let explanationHTML = '';
            if (p.type === 'temperature') {
                explanationHTML = `${p.initialValue} ${p.fromUnit} ${p.operation} ${p.operand} = ${p.answer.toLocaleString('es-ES', { maximumFractionDigits: 4 })} ${p.toUnit}`;
            } else if (p.type === 'scientific') {
                explanationHTML = `${p.instruction}<br>`;
                if(p.answer.exponent !== undefined) explanationHTML += `Respuesta: ${p.answer.mantissa} × 10<sup>${p.answer.exponent}</sup> ${p.answer.unit || ''}`;
                else explanationHTML += `Respuesta: ${p.answer.mantissa}`;
            } else {
                explanationHTML = `${p.initialValue} ${p.fromUnit}`;
                (p.factors || []).forEach(f => { explanationHTML += ` × (${f.num} ${f.num_unit} / ${f.den} ${f.den_unit})`; });
                explanationHTML += ` = ${p.answer.toLocaleString('es-ES', { maximumFractionDigits: 4 })} ${p.toUnit}`;
            }
            
            feedbackContainer.classList.remove('hidden');
            feedbackContainer.innerHTML = `<div class="p-4 rounded-lg flex items-start gap-4 ${isCorrect ? 'bg-green-100 border-green-300' : 'bg-red-100 border-red-300'}"><div class="flex-shrink-0 text-2xl">${isCorrect ? '✅' : '❌'}</div><div><h3 class="text-lg font-bold ${isCorrect ? 'text-green-700' : 'text-red-700'}">${isCorrect ? '¡Excelente!' : '¡Casi lo tienes!'}</h3><p class="text-gray-700 mt-1">${isCorrect ? 'Has completado el proceso correctamente.' : errors.join('<br>')}</p></div></div><div class="mt-4 p-4 bg-gray-100/70 border rounded-lg"><h4 class="font-semibold text-theme-600 mb-2">Planteamiento Correcto:</h4><p class="text-sm text-gray-600 font-mono break-words">${explanationHTML}</p></div>`;
            document.getElementById('check-btn').classList.add('hidden');
            const nextButton = document.getElementById('next-btn');
            nextButton.classList.remove('hidden');
            nextButton.textContent = gameState.current < gameState.total ? 'Siguiente →' : 'Ver Puntuación Final';
            gameView.querySelectorAll('input').forEach(i => i.disabled = true);
        };
        
        function endGame() {
            showView(gameOverView);
            document.getElementById('final-score-text').textContent = `Tu puntuación fue: ${gameState.score} de ${gameState.total}.`;
        }

        updateStatsDisplay();
        showView(mainMenu);
    });
    </script>
</body>
</html>

